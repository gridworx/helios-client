# Helios Client - Development Docker Compose
# Usage: docker compose -f docker-compose.dev.yml up -d
#
# Features:
#   - Hot reload enabled (volume mounts for src files)
#   - npm run dev for both frontend and backend
#   - Default admin created on first startup
#
# Default Login:
#   Email: admin@example.com
#   Password: admin123
#   (Change password after first login!)
#
# For production, use the default: docker compose up -d

services:
  nginx:
    image: nginx:alpine
    container_name: helios_client_nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/error-pages:/usr/share/nginx/html/error-pages:ro
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      - helios_client_network

  postgres:
    image: postgres:16-alpine
    container_name: helios_client_postgres
    environment:
      POSTGRES_DB: helios_client
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    # Internal only - accessible via Docker network, not externally
    # Uncomment for local debugging: ports: ["127.0.0.1:5432:5432"]
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/schema_organization.sql:/docker-entrypoint-initdb.d/01-schema.sql
    networks:
      - helios_client_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: helios_client_redis
    # Internal only - accessible via Docker network, not externally
    networks:
      - helios_client_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: helios_client_minio
    command: server /data --console-address ":9001"
    environment:
      # MinIO credentials must match backend S3_ACCESS_KEY/S3_SECRET_KEY
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-minioadmin123}
    # Internal only - accessible via Docker network, not externally
    # Uncomment for local debugging: ports: ["127.0.0.1:9000:9000", "127.0.0.1:9001:9001"]
    volumes:
      - minio_data:/data
    networks:
      - helios_client_network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: helios_client_backend
    user: root
    # Internal only - nginx proxies /api requests
    # Uncomment for local debugging: ports: ["127.0.0.1:3001:3001"]
    environment:
      NODE_ENV: development
      PORT: 3001
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: helios_client
      DB_USER: postgres
      DB_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: dev-secret-key-not-for-production
      JWT_EXPIRES_IN: 8h
      REFRESH_TOKEN_EXPIRES_IN: 7d
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}
      FRONTEND_URL: http://localhost:80
      RATE_LIMIT_ENABLED: false
      # Default admin credentials (created on first startup)
      # Change password after first login!
      DEFAULT_ADMIN_EMAIL: ${DEFAULT_ADMIN_EMAIL:-admin@example.com}
      DEFAULT_ADMIN_PASSWORD: ${DEFAULT_ADMIN_PASSWORD:-admin123}
      DEFAULT_ORG_NAME: ${DEFAULT_ORG_NAME:-Development Org}
      DEFAULT_ORG_DOMAIN: ${DEFAULT_ORG_DOMAIN:-example.com}
      # MinIO S3 Configuration
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin123}
      S3_BUCKET_PRIVATE: ${S3_BUCKET_PRIVATE:-helios-uploads}
      S3_BUCKET_PUBLIC: ${S3_BUCKET_PUBLIC:-helios-public}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_USE_SSL: ${S3_USE_SSL:-false}
      S3_PUBLIC_URL: ${S3_PUBLIC_URL:-http://localhost:9000}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - helios_client_network
    volumes:
      - ./backend/src:/app/src
      - ./backend/package.json:/app/package.json
      - ./backend/tsconfig.json:/app/tsconfig.json
      - ./database:/database
    command: npm run dev

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: helios_client_frontend
    # Internal only - nginx proxies all requests
    # Uncomment for local debugging: ports: ["127.0.0.1:3000:3000"]
    environment:
      # DOCKER_ENV tells Vite to proxy API requests to 'backend:3001' instead of 'localhost:3001'
      DOCKER_ENV: "true"
      # Empty VITE_API_URL means use relative URLs (same origin via nginx proxy)
      # This allows remote access without hardcoding localhost
      VITE_API_URL: ""
      VITE_DEFAULT_THEME: ${VITE_DEFAULT_THEME:-helios-purple}
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - helios_client_network
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/index.html:/app/index.html
      - ./frontend/vite.config.ts:/app/vite.config.ts
    command: npm run dev -- --host 0.0.0.0

volumes:
  postgres_data:
    name: helios_client_postgres_data
  minio_data:
    name: helios_client_minio_data

networks:
  helios_client_network:
    name: helios_client_network
    driver: bridge